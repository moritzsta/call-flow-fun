{
  "name": "Finder-Felix [Webhook]",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "finder-felix",
        "authentication": "headerAuth",
        "options": {}
      },
      "id": "webhook-trigger-felix",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [240, 300],
      "webhookId": "finder-felix-webhook",
      "credentials": {
        "headerAuth": {
          "id": "1",
          "name": "Header Auth"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Parse incoming webhook data\nconst body = $input.item.json.body;\n\nreturn {\n  workflow_id: body.workflow_id,\n  project_id: body.project_id,\n  user_id: body.user_id,\n  user_input: body.trigger_data?.user_input || '',\n  search_params: body.trigger_data?.search_params || {}\n};"
      },
      "id": "parse-webhook-input-felix",
      "name": "Parse Webhook Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "location-input",
              "name": "user_message",
              "value": "={{ $json.user_input }}",
              "type": "string"
            },
            {
              "id": "project-id",
              "name": "project_id",
              "value": "={{ $json.project_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-ai-input",
      "name": "Prepare AI Input",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [680, 300]
    },
    {
      "parameters": {
        "agent": "conversationalAgent",
        "promptType": "define",
        "text": "=Du bist Finder-Felix, ein hilfreicher Assistent der Firmen in Deutschland findet.\n\nDer Nutzer sucht nach: {{ $json.user_message }}\n\nAnalysiere die Anfrage und extrahiere:\n- Bundesland (state)\n- Stadt (city) \n- Branche (industry)\n\nNutze dann die verf√ºgbaren Tools um passende Firmen zu finden.",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "Du bist Felix, ein professioneller Firmen-Recherche-Assistent."
        }
      },
      "id": "ai-agent-felix",
      "name": "Finder Felix Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [900, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://www.gelbeseiten.de/Suche/{{ $json.industry }}/{{ $json.city }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "fetch-gelbeseiten",
      "name": "Fetch Gelbe Seiten",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "functionCode": "// Extract company data from HTML\nconst html = $input.item.json.body;\nconst companies = [];\n\n// Simple regex extraction (in production use proper HTML parser)\nconst companyRegex = /<div class=\"mod mod-Treffer\"[^>]*>([\\s\\S]*?)<\\/div>/g;\nlet match;\n\nwhile ((match = companyRegex.exec(html)) !== null) {\n  const companyBlock = match[1];\n  \n  const nameMatch = /<h2[^>]*>([^<]+)<\\/h2>/.exec(companyBlock);\n  const addressMatch = /<span[^>]*class=\"[^\"]*address[^\"]*\"[^>]*>([^<]+)<\\/span>/.exec(companyBlock);\n  const phoneMatch = /<a[^>]*href=\"tel:([^\"]+)\"/.exec(companyBlock);\n  \n  if (nameMatch) {\n    companies.push({\n      company: nameMatch[1].trim(),\n      address: addressMatch ? addressMatch[1].trim() : null,\n      phone: phoneMatch ? phoneMatch[1].trim() : null,\n      city: $('input').first().json.city,\n      state: $('input').first().json.state,\n      industry: $('input').first().json.industry,\n      project_id: $('input').first().json.project_id\n    });\n  }\n}\n\nreturn companies.map(c => ({ json: c }));"
      },
      "id": "extract-companies",
      "name": "Extract Companies",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "tableId": "companies",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "company",
              "fieldValue": "={{ $json.company }}"
            },
            {
              "fieldId": "address",
              "fieldValue": "={{ $json.address }}"
            },
            {
              "fieldId": "phone",
              "fieldValue": "={{ $json.phone }}"
            },
            {
              "fieldId": "city",
              "fieldValue": "={{ $json.city }}"
            },
            {
              "fieldId": "state",
              "fieldValue": "={{ $json.state }}"
            },
            {
              "fieldId": "industry",
              "fieldValue": "={{ $json.industry }}"
            },
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $json.project_id }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "found"
            }
          ]
        }
      },
      "id": "insert-companies-supabase",
      "name": "Insert Companies",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1560, 300],
      "credentials": {
        "supabaseApi": {
          "id": "2",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "n8n_workflow_states",
        "filterType": "manual",
        "matchBy": "id",
        "matchValue": "={{ $('Parse Webhook Input').item.json.workflow_id }}",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "completed"
            },
            {
              "fieldId": "completed_at",
              "fieldValue": "={{ $now.toISO() }}"
            },
            {
              "fieldId": "result_summary",
              "fieldValue": "={{ { companies_found: $items().length } }}"
            }
          ]
        }
      },
      "id": "update-workflow-state-felix",
      "name": "Update Workflow State",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1780, 300],
      "credentials": {
        "supabaseApi": {
          "id": "2",
          "name": "Supabase"
        }
      }
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Parse Webhook Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Webhook Input": {
      "main": [
        [
          {
            "node": "Prepare AI Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare AI Input": {
      "main": [
        [
          {
            "node": "Finder Felix Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finder Felix Agent": {
      "main": [
        [
          {
            "node": "Fetch Gelbe Seiten",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Gelbe Seiten": {
      "main": [
        [
          {
            "node": "Extract Companies",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Companies": {
      "main": [
        [
          {
            "node": "Insert Companies",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Companies": {
      "main": [
        [
          {
            "node": "Update Workflow State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-26T12:00:00.000Z",
  "versionId": "1"
}
